# ç›®å½•

[TOC]



# å®éªŒè®°å½• 2019-11-08

##å¯ä»¥è¯»dblpçš„æ•°æ®

ä¹‹å‰å°è¯•ä½¿ç”¨spark-xmlè¯»å–dblpçš„æ•°æ®ï¼Œä½†æ˜¯è¯»å–è¿‡ç¨‹ä¸­å‘ç”ŸOOMå¼‚å¸¸ã€‚

ä¸€æ¬¡æ€§è¯»å–å…¨éƒ¨dblpæ•°æ®çš„ä»£ç å¦‚ä¸‹ï¼š

```scala
    val df = spark.read
      .format("com.databricks.spark.xml")
      .option("rowTag", "dblp")
      .load("file:///root/dblp.xml")
```

è¿™ç§è¯»å–çš„æ–¹å¼å¯¼è‡´sparkçš„Excutorç«¯ç”Ÿæˆäº†è¿‡äºåºå¤§çš„SchemaRDDï¼Œå¯¼è‡´äº†OOMå¼‚å¸¸ã€‚åœ¨æŸ¥é˜…äº†spark-xmlçš„README.mdæ–‡ä»¶åï¼Œæœ€ç»ˆå‘ç°äº†æ­£ç¡®çš„è¯»å–æ–¹å¼ã€‚



README.mdä¸­optionæ”¯æŒçš„é€‰é¡¹éƒ¨åˆ†æ‰¾åˆ°å…³äº`rowTag`å’Œ`rootTag`çš„è¯´æ˜ï¼š

>* `rowTag`: The row tag of your xml files to treat as a row. For example, in this xml `<books> <book><book> ...</books>`, the appropriate value would be `book`. Default is `ROW`.
>* `rootTag`: The root tag of your xml files to treat as the root. For example, in this xml `<books> <book><book> ...</books>`, the appropriate value would be `books`. Default is `ROWS`.

ç®€å•çš„è¯´`rowTag`é€‰é¡¹æ˜¯ç”¨æ¥è®¾ç½®è¦å°†ä»€ä¹ˆxmlèŠ‚ç‚¹è½¬æ¢ä¸ºDataFrameçš„rowï¼Œè€Œ`rootTag`ç”¨æ¥è®¾ç½®è¦å°†æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºå“ªä¸ªèŠ‚ç‚¹ã€‚

è¿™æ ·å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆä¸€æ¬¡æ€§è¯»å–dblpçš„ä»£ç ä¼šå¯¼è‡´OOMå¼‚å¸¸ã€‚å› ä¸ºdblp.xmlçš„æ ¹èŠ‚ç‚¹æ˜¯dblpèŠ‚ç‚¹ï¼Œä½†æ˜¯å´è¢«å½“æˆäº†rowã€‚è¿™ä¼šåœ¨Excutorç«¯ç”Ÿæˆäº†ä¸€ä¸ªå·¨å¤§çš„RDDå¯¹è±¡ï¼Œå¯¼è‡´OOMã€‚



èƒ½å¤Ÿä¸å¯¼è‡´OOMçš„å‚æ•°è®¾ç½®å¦‚ä¸‹ï¼š

```scala
    val df = spark.read
      .format("com.databricks.spark.xml")
      .option("rootTag", "dblp")
 			.option("rowTag", "article")
      .load("file:///root/dblp.xml")
```

é¿å…ä¸€æ¬¡è¯»å–å…¨éƒ¨dblp.xmlæ•°æ®ï¼Œé‡‡ç”¨åˆ†åˆ«è¯»å–dblpæ ¹èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹çš„æ–¹å¼è¯»å–ã€‚



ä½†æ˜¯dblpæ•°æ®é›†çš„å¤§å°æœ‰2gï¼Œæˆ‘ä»¬æ²¡æ³•çŸ¥é“dblpä¸‹ä¸€å±‚çš„å­èŠ‚ç‚¹éƒ½æ˜¯ä»€ä¹ˆï¼Ÿäºæ˜¯å‚è€ƒäº†dblp.dtdæ–‡ä»¶ï¼Œå¾—çŸ¥äº†dblpä¸‹çš„å­—èŠ‚ç‚¹åç§°ã€‚å¹¶å¯¹å„ä¸ªå­—èŠ‚ç‚¹çš„è®°å½•æ•°é‡è¿›è¡Œäº†ç»Ÿè®¡ã€‚

| subElement    | Count   |
| ------------- | ------- |
| article       | 2093906 |
| inproceedings | 2450274 |
| proceedings   | 41782   |
| book          | 17714   |
| incollection  | 59477   |
| phdthesis     | 73252   |
| mastersthesis | 12      |
| www           | 2346866 |
| person        | 0       |
| data          | 0       |

ä¸‹ä¸€æ­¥å‡†å¤‡å°†å„ä¸ªå­èŠ‚ç‚¹å†™å…¥å•ç‹¬çš„xmlæ–‡ä»¶é‡Œ

#å®éªŒè®°å½• 2019-11-14

##ä¿®æ”¹äº†dblpä¸­çš„å®ä½“å®šä¹‰ä¸ºlatin-1ç¼–ç 

è¯»å–æ–‡ä»¶æ—¶å‘ç°å‡ºç°äº†å¤§é‡çš„è®°å½•æ˜¾ç¤ºcorrupt_record

| _corrupt_record | _key | _mdate | _publtype | author | ee   |
| --------------- | ---- | ------ | --------- | ------ | ---- |
|                null|     tr/meltdown/s18|2018-01-07| informal|[Paul Kocher, Dan...|                null|https://spectreat...|
|<article mdate="2...|                null|      null|     null|                null|                null|                null|
|<article mdate="2...|                null|      null|     null|                null|                null|                null|


æ’æŸ¥ä»¥åå‘ç°æ˜¯ç”±äºdblp.xmlå­˜åœ¨ä¸€äº›xmlå®ä½“å®šä¹‰å¯¼è‡´spark-xmlä¸èƒ½æ­£å¸¸è¯»å–ã€‚

```xml
    <article mdate="2017-06-08" key="tr/ibm/IWBS191" publtype="informal">
        <author>Rolf Sander</author>
        <title>Die Repr&auml;sentation r&auml;umlichen Wissens und die Behandlung von Einbettungsproblemen mit Quadtreedepiktionen
        </title>
        <journal>IWBS Report</journal>
        <volume>191</volume>
        <year>1991</year>
        <publisher>IBM Germany Science Center, Institute for Knowledge Based Systems</publisher>
    </article>
```

æŸ¥é˜…äº†spark-xmlçš„readmeæ²¡æœ‰å‘ç°å¯ä»¥æ ¹æ®dtdçš„å®ä½“å®šä¹‰æ›¿æ¢ä¸ºå¯¹åº”çš„latin-1ç¼–ç å­—ç¬¦çš„æ–¹æ³•ï¼Œäºæ˜¯æ‰“ç®—å°†å®ä½“å®šä¹‰ç›¸å…³çš„å­—ç¬¦ä¸²ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¹¶æ›¿æ¢ã€‚è¯»å–dblp.xmlæ›¿æ¢ç›¸åº”çš„å­—ç¬¦ä¸²ä»¥åå†™åˆ°dblp_after.xmlæ–‡ä»¶ä¸­ã€‚

```scala
import java.io.File
import org.apache.spark.sql.SparkSession
object Test4 {
  val s1 = "file:////Users/gaoxin/WorkSpace/spark/dblp.xml"
  //å°†å®ä½“æ›¿æ¢ä»¥åçš„dblpå†™åœ¨è¿™é‡Œ
  val s2 = "file:////Users/gaoxin/WorkSpace/spark/dblp_after.xml"

  def main(args: Array[String]): Unit = {
    val spark = SparkSession
      .builder
      .appName("XML_Test")
      .master("local[*]")
      .getOrCreate()

    val subNode = Array("article")
    
    //æ–‡æœ¬æ–¹å¼è¯»å–
    val file = spark.sparkContext.textFile(s1)

    //è½¬æ¢å®ä½“
    val afterParse = file.map(s => ReplaceEntity.parse(s))
    
    //afterParse.foreach(it => println(it))

    val afterParedblp: File = new File(s2)

   if (afterParedblp.isFile) {
     println("delete "+ afterParedblp.delete())
   }

    afterParse.saveAsTextFile(s2)
  }
}
```



**å°†å®ä½“åç§°æ›¿æ¢ä¸ºå®ä½“ç¼–å·çš„æ–¹å¼å°½ç®¡å¯ä»¥åœ¨ideä¸‹æ­£å¸¸æ˜¾ç¤ºï¼Œä½†æ˜¯ä½¿ç”¨æ§åˆ¶å°çš„æ—¶å€™ä»ç„¶æ˜¾ç¤ºä¹±ç ã€‚åº”è¯¥æ›¿æ¢ä¸ºå…·ä½“å­—ç¬¦ã€‚ä¸‹é¢çš„ä»£ç å¹¶æ²¡æœ‰æ ¹æœ¬åœ°è§£å†³é—®é¢˜ï¼Œä»¥åéœ€è¦æ”¹ã€‚**

```scala
import scala.util.matching.Regex

object ReplaceEntity {
  val regex: Regex = new Regex("&[A-Za-z]*;")
  def parse(s: String): String = {
    val optS = regex.replaceAllIn(s, it => it.toString() match {
      case "&reg;" => "&#174;"
      case "&micro;" => "&#181;"
      case "&times;" => "&#215;"
      case "&Agrave;" => "&#192;"
      case "&Aacute;" => "&#193;"
      case "&Acirc;" => "&#194;"
//.....çœç•¥
      case _ => {
        println(it)
        it.toString()
      }
    })

    optS
  }
}
```

ç»è¿‡å®ä½“æ›¿æ¢ä»¥åçš„dblp_after.xmlå¯ä»¥æ­£å¸¸è¯»å–ï¼Œæ£€æŸ¥äº†dataframeçš„è®°å½•ä¹Ÿæ²¡æœ‰å‘ç°corrupt_recordã€‚

#å®éªŒè®°å½• 2019-11-21

å¯ä»¥è¿›è¡Œç®€å•çš„æŸ¥è¯¢äº†

##é€‰å–ç‰¹å®šçš„åˆ—

```scala
    import spark.implicits._
    dblpArticle.select($"title", $"author", $"url").show()
```

| title                | author               | url                  |
| -------------------- | -------------------- | -------------------- |
| Spectre Attacks: ... | [[Paul Kocher,,],... | null                 |
| Meltdown             | [[Moritz Lipp,,],... | null                 |
| An Evaluation of ... | [[Frank Manola,,]]   | db/labs/gte/index... |

## æ ¹æ®longç±»å‹æ‰§è¡Œè¿‡æ»¤

```scala
import spark.implicits._
dblpArticle.filter($"year" > 2000).show()
```

| title                | author               | year                 |
| -------------------- | -------------------- | -------------------- |
|Spectre Attacks: ...|[[Paul Kocher,,],...|2018|
|            Meltdown|[[Moritz Lipp,,],...|2018|

## å­—ç¬¦ä¸²æ­£åˆ™åŒ¹é…

```scala
import spark.implicits._
dblpArticle.select($"title", $"author", $"url").filter($"title" rlike "^Knowledge").show()
```
| title                | author               | year                 |
| -------------------- | -------------------- | -------------------- |
|Knowledge in Oper...|[[Toni Bollinger,...|null|

å…¶ä»–çš„å†™åœ¨æµ‹è¯•ä»£ç é‡Œäº†

# å®éªŒè®°å½• 2020-02-20

é€šè¿‡dockerå’Œdocker-composeæ­å»ºäº†å®éªŒç¯å¢ƒã€‚

1. Mongodbç¯å¢ƒ
2. Sparkå’ŒHDFSçš„ç¯å¢ƒï¼ˆå¯åœ¨å•æœºè¿›è¡Œä¼ªåˆ†å¸ƒå¼å®éªŒï¼‰
3. Hadoop Yarnç¯å¢ƒï¼ˆå¯åœ¨å•æœºè¿›è¡Œä¼ªåˆ†å¸ƒå¼å®éªŒï¼‰

Sparkç¯å¢ƒå’ŒHadoopç¯å¢ƒæ˜¯ä»¥åˆ«äººçš„dockerfileä¸ºåŸºç¡€æ”¹çš„è¿™æ˜¯Githubçš„åœ°å€ï¼šhttps://github.com/big-data-europe/docker-hadoop

# å®éªŒè®°å½• 2020-02-27

lmhå°†è¿›è¡Œè¿‡é¢„å¤„ç†çš„æ•°æ®å†™å…¥äº†Mongodbï¼Œæ•°æ®å¯ä»¥æ­£å¸¸å†™å…¥ï¼Œå¹¶é€šè¿‡Mongodbè¯»å–ã€‚

è®©xxkå­¦ä¹ é€šè¿‡SpringBoot-jpaç»„ä»¶è¯»å–Mongodbã€‚

# å®éªŒè®°å½• 2020-03-10

å°†ä¹‹å‰çš„ç ”ç©¶æˆæœè¿›è¡Œæ•´ç†

å»ºç«‹è¿œç¨‹ä»“åº“ï¼šhttps://github.com/FHamster/SparkExp

# å®éªŒè®°å½• 2020-03-11

## å‘ç°äº†titleå­—æ®µç©ºç™½çš„é”™è¯¯

ç¿»çœ‹mongodbå†…çš„æ•°æ®æ—¶å‘ç°äº†ä¸¥é‡çš„é”™è¯¯ï¼Œå¤§é‡çš„titleå­—æ®µä¸€ç‰‡ç©ºç™½ã€‚

æ’æŸ¥ä»¥åå‘ç°æ˜¯spark-xmlæ¨å¯¼å‡ºäº†ä¸æœŸæœ›çš„schemaï¼Œå¯¼è‡´titleèŠ‚ç‚¹çš„æ–‡æœ¬å…¨éƒ¨æ²¡è¯»ã€‚

spark-xmlæ¨æµ‹çš„schemaï¼š

```
root
 |-- _cdate: string (nullable = true)
 |-- _key: string (nullable = true)
 |-- _mdate: string (nullable = true)
 |-- _publtype: string (nullable = true)
 |-- author: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- _VALUE: string (nullable = true)
 |    |    |-- _aux: string (nullable = true)
 |    |    |-- _orcid: string (nullable = true)
 |-- booktitle: string (nullable = true)
 |-- cdrom: string (nullable = true)
 |-- cite: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- _VALUE: string (nullable = true)
 |    |    |-- _label: string (nullable = true)
 |-- crossref: string (nullable = true)
 |-- editor: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- _VALUE: string (nullable = true)
 |    |    |-- _orcid: string (nullable = true)
 |-- ee: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- _VALUE: string (nullable = true)
 |    |    |-- _type: string (nullable = true)
 |-- journal: string (nullable = true)
 |-- month: string (nullable = true)
 |-- note: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- _VALUE: string (nullable = true)
 |    |    |-- _type: string (nullable = true)
 |-- number: string (nullable = true)
 |-- pages: string (nullable = true)
 |-- publisher: string (nullable = true)
 |-- title: struct (nullable = true)
 |    |-- _VALUE: string (nullable = true)
 |    |-- _bibtex: string (nullable = true)
 |    |-- i: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- sub: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- sup: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |-- url: string (nullable = true)
 |-- volume: string (nullable = true)
 |-- year: long (nullable = true)

```

å®šä½äº†å¯¼è‡´è¿™ç§ç°è±¡çš„xmlè®°å½•

```xml
<title>&#120001;<sub>0</sub> Regularized Structured Sparsity Convolutional Neural Networks.</title>

<title>Beyond Ohba's Conjecture: A bound on the choice number of <i>k</i>-chromatic graphs with <i>n</i> vertices.</title>

<title>Asynchronous machine vector control: PI<sup>&#945;</sup> controllers for current loops.</title>
```



åœ¨dblpç½‘ç«™çš„æ˜¾ç¤ºæ•ˆæœ

* **ğ“**0 Regularized Structured Sparsity Convolutional Neural Networks.
* Beyond Ohba's Conjecture: A bound on the choice number of *k*-chromatic graphs with *n* vertices.
* Average dwell time approach to *H*âˆ filter for continuous-time switched linear parameter varying systems with time-varying delay.

**å‘ç°æ–‡ç« çš„æ ‡é¢˜æœ‰ç‰¹æ®Šçš„æ–‡æœ¬æ•ˆæœï¼Œä½†æ˜¯spark-xmlåœ¨å¤„ç†æ—¶ä¸¢å¤±äº†è¿™éƒ¨åˆ†çš„è¯­æ„ã€‚éœ€è¦è¿›è¡Œè¿›ä¸€æ­¥çš„é¢„å¤„ç†ã€‚å¹¶ä¸”è¿™æ„å‘³**

1. ç€å…¶ä»–çš„dblpä¸‹çš„ä¸€çº§å­—èŠ‚ç‚¹ä¹Ÿä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦äººå·¥è®¾å®šä¸å°‘çš„schema ï¼ˆå¤´ç–¼ï¼‰
2. ç½‘é¡µæ˜¾ç¤ºå·¥ä½œéœ€è¦åŠ å…¥è¿™ç§æ˜¾ç¤ºåŠŸèƒ½ ï¼ˆå¤´æ›´ç–¼ï¼‰







# å®éªŒè®°å½• 2020-04-08

## å°è¯•è§£å†³titleç©ºç™½é—®é¢˜ï¼ŒæœªæˆåŠŸ

å°è¯•æ‰‹åŠ¨è®¾å®šschemaä»¥åä»ç„¶äº§ç”Ÿè¿™æ ·çš„ç°è±¡ï¼Œ**æ•ˆæœä¸å¥½**

```json
[
  {
    "title": " Transferability of Adversarial Examples to Attack Cloud-based Image Classifier Service."
  },
  {
    "title": "! and ? - Storage as Tensorial Strength."
  },
  {
    "title": "!MDP Playground: Meta-Features in Reinforcement Learning."
  },
  {
    "title": "\""
  },
  {
    "title": "\""
  },
  {
    "title": "\""
  },
  //è¿™é‡Œçœç•¥
  [
  {
    "title": "\uD83D\uDC4D as social support: Relational closeness, automaticity, and interpreting social support from paralinguistic digital affordances in social media."
  },
  {
    "title": "\uD835\uDD43"
  },
  {
    "title": "\uD835\uDD3D"
  },
  {
    "title": "\uD835\uDD3D"
  },
  {
    "title": "\uD835\uDCDE(k)-robust spanners in one dimension."
  },
  {
    "title": "\uD835\uDCC1"
  },
  {
    "title": "\uD835\uDCC1"
  },
  {
    "title": "\uD835\uDCC1"
  },
  {
    "title": "\uD835\uDCC1"
  },
  {
    "title": "\uD835\uDCC1"
  },
  {
    "title": "\uD835\uDCB1\uD835\uDCB0-smoothness and proximal point results for some nonconvex functions."
  },
  {
    "title": "\uD835\uDCAB-schemes and Deterministic Polynomial Factoring over Finite Fields."
  },
  {
    "title": "í”½"
  },
  {
    "title": "í’Ÿ-stability performance analysis and stabilization of Sun-Earth "
  },
  {
    "title": "í’-Consistency in signed total graphs of commutative rings."
  }
]
]
```

ç›®å‰è®¡åˆ’é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢```<sub>``` ```<sup>``` ```<i>```è¿™æ ·çš„æ ‡ç­¾ï¼Œåœ¨æˆåŠŸè¯»å–ä¸ºdataframeä»¥åå†é€šè¿‡dataframeä¸­è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢

## å¯¹titleå­—æ®µçš„ä¸€äº›å‘ç°

```
 |-- title: struct (nullable = true)
 |    |-- _VALUE: string (nullable = true)
 |    |-- _bibtex: string (nullable = true)
 |    |-- i: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- sub: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- sup: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
```

```_VALUE```:titleçš„æ–‡æœ¬

```i```:æ–œä½“
```sup```:ä¸Šæ ‡
```sub```:ä¸‹æ ‡

```_bibtex```:ä½¿ç”¨bibtexè¯­æ³•æè¿°çš„title

```tt```:è¡¥å……çš„

# å®éªŒè®°å½• 2020-04-16

é€šè¿‡æ›¿æ¢æ ‡ç­¾å­—ç¬¦ä¸²çš„æ–¹å¼è§£å†³äº†titleç©ºç™½é—®é¢˜ã€‚

å¼€å§‹å°è¯•å°†æ‰€æœ‰dblpä¸‹çš„å­èŠ‚ç‚¹å†™å…¥mongodb

å†™å…¥æˆåŠŸï¼Œç›®å‰åœ¨æ£€æŸ¥æœ‰æ²¡æœ‰ä¿¡æ¯ä¸¢å¤±æƒ…å†µã€‚



# è¿›å±•ç®€æŠ¥

å·²ç»å®Œæˆäº†dblpå…¨é‡å†™å…¥mongodbæ•°æ®åº“çš„å·¥ä½œï¼Œç°åœ¨æ­£åœ¨æ£€æŸ¥æœ‰æ²¡æœ‰æ•°æ®å‡ºé”™çš„æƒ…å†µã€‚

æ—è°‹ç€šå’Œé«˜æ˜•æ­£åœ¨è¿›è¡Œæ•°æ®æ£€æŸ¥ï¼Œè¿˜æœ‰æ€è€ƒä¼˜åŒ–æŸ¥è¯¢ä¼˜åŒ–çš„ç­–ç•¥ã€‚æˆ‘ä»¬ç›®å‰çš„æƒ³æ³•æœ‰å¼•å…¥æœå¨ç¼–ç çš„æ–¹å‘ã€ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹å‘ã€è¿˜æœ‰å€ŸåŠ©mongodbçš„ç´¢å¼•çš„æ–¹å‘ã€‚

è°¢æ—­å¤å’Œå¼ æ¬£ç°åœ¨åœ¨è¿›è¡ŒSpringBootæŸ¥è¯¢mongodbçš„æ¢ç´¢ã€‚

ç”±äºç›®å‰å®éªŒæ¡ä»¶çš„é™åˆ¶ï¼Œæ²¡æœ‰æœåŠ¡å™¨é›†ç¾¤å¯ä»¥ä½¿ç”¨ã€‚æ‰€ä»¥ç›®å‰å…ˆç”¨çš„æ˜¯dockeråœ¨ä¸ªäººç”µè„‘æ­å»ºä¼ªåˆ†å¸ƒå¼å®éªŒç¯å¢ƒã€‚ç°åœ¨æœ‰ä¸‰å¥—dockerç¯å¢ƒï¼š

1. Mongodbç¯å¢ƒ
2. Sparkå’ŒHDFSçš„ç¯å¢ƒ
3. Hadoop Yarnç¯å¢ƒ

ä»£ç æ‰˜ç®¡è‡³github: https://github.com/FHamster/SparkExp.git



# å®éªŒè®°å½• 2020-05-10

å‘ç°spark-xmlè¿›è¡Œæ•°æ®æ¨¡å¼æ¨å¯¼çš„ç»“æœä¸æ˜¯å¾ˆç»Ÿä¸€ã€‚ä¸ºäº†æ–¹ä¾¿æœåŠ¡å™¨å–æ•°æ®ï¼Œæˆ‘ä»¬æ‰‹å·¥è®¾å®šDataframeçš„schemaã€‚å¦‚ä¸‹æ˜¯articleæ‰‹å·¥è®¾å®šçš„Dataframeæ•°æ®æ¨¡å¼ã€‚é™¤æ­¤ä¹‹å¤–ä¹Ÿè®¾ç½®äº†å…¶ä»–çš„ï¼Œæ¯”å¦‚inproceedingsã€proceedingsç­‰ã€‚

```scala
  //è®¾å®šarticle schemaçš„scalaä»£ç 
  val articleSchema:StructType = new StructType(Array(
    StructField("_cdate", StringType, nullable = true),
    StructField("_key", StringType, nullable = true),
    StructField("_mdate", StringType, nullable = true),
    StructField("_publtype", StringType, nullable = true),
    StructField("author", ArrayType(
      StructType(Array(
        StructField("_VALUE", StringType, nullable = true),
        StructField("_orcid", StringType, nullable = true),
        StructField("_aux", StringType, nullable = true)
      )), containsNull = true)
    ),
    StructField("booktitle", StringType, nullable = true),
    StructField("cdrom", StringType, nullable = true),
    StructField("cite", ArrayType(
      StructType(Array(
        StructField("_VALUE", StringType, nullable = true),
        StructField("_label", StringType, nullable = true)
      )), containsNull = true)
    ),
    StructField("crossref", StringType, nullable = true),
    StructField("editor", ArrayType(
      StructType(Array(
        StructField("_VALUE", StringType, nullable = true),
        StructField("_orcid", StringType, nullable = true)
      )), containsNull = true)
    ),
    StructField("ee", ArrayType(
      StructType(Array(
        StructField("_VALUE", StringType, nullable = true),
        StructField("_type", StringType, nullable = true)
      )), containsNull = true)
    ),
    StructField("journal", StringType, nullable = true),
    StructField("month", StringType, nullable = true),
    StructField("note", ArrayType(
      StructType(Array(
        StructField("_VALUE", StringType, nullable = true),
        StructField("_type", StringType, nullable = true)
      )), containsNull = true)
    ),
    StructField("number", StringType, nullable = true),
    StructField("pages", StringType, nullable = true),
    StructField("publisher", StringType, nullable = true),
    StructField("title", StructType(Array(
      StructField("_VALUE", StringType, nullable = true),
      StructField("_bibtex", StringType, nullable = true),
    )), nullable = true),
    StructField("url", StringType, nullable = true),
    StructField("volume", StringType, nullable = true),
    StructField("year", LongType, nullable = true)
  ))
```

# å®éªŒè®°å½• 2020-05-12

ä¸ºäº†èƒ½å¤Ÿå¾—åˆ°ä¸€ä»½DBLPçš„æ‰€æœ‰authorçš„åˆ—è¡¨æˆ‘ä»¬åœ¨mongodbæ–°å»ºäº†ä¸€ä¸ªauthoræ–‡æ¡£ã€‚å¹¶å°†ä½œè€…ä¿¡æ¯å¯¼å…¥ï¼Œå¹¶è¿›è¡Œå»é‡ã€‚

```scala
//è¿™é‡Œå°†ä½œè€…ä¿¡æ¯å¯¼å…¥authoræ–‡æ¡£
test("article") {
    import com.databricks.spark.xml._
    val subnode = "article"
    val ss: SparkSession = SparkSession
      .builder
      .appName("Write_article")
      .master("local[*]")
      .config("spark.mongodb.output.uri", s"mongodb://127.0.0.1/SparkDBLPTest.Property.Author")
      .getOrCreate()

    val opt = ss.read
      .option("rootTag", "dblp")
      .option("rowTag", subnode)
      .schema(PropertiesObj.articleSchema)
      .xml(PropertiesObj.wholeDBLP_cvtSparkPath)

    import ss.implicits._
    val res = opt
      .select(explode($"author") as "author")
      .select($"author._VALUE" as "_VALUE",
        $"author._orcid" as "_orcid",
        $"author._aux" as "_aux"
      ).distinct()
      .sort($"_VALUE")

    println(s"write $subnode into mongodb")
    MongoSpark.save(res)
    ss.stop()
  }

//è¿™é‡Œå¯¹authoræ–‡æ¡£è¿›è¡Œå»é‡æ“ä½œ
test("distinct author") {
    import com.mongodb.spark.config._
    val sparkSession: SparkSession = SparkSession
      .builder
      .appName("in")
      .master("local[*]")
      .config("spark.mongodb.output.uri", s"mongodb://127.0.0.1/SparkDBLPTest.Property.Author")
      .config("spark.mongodb.input.uri", s"mongodb://127.0.0.1/SparkDBLPTest.Property.Author")
      .getOrCreate()

    import com.mongodb.spark.config._
    import sparkSession.implicits._
    val customReadConfig = ReadConfig(Map(
      "readPreference.name" -> "secondaryPreferred"),
      Some(ReadConfig(sparkSession)))
    val df = sparkSession.read.format("mongo").options(customReadConfig.asOptions).load()

    println(df.count())
    val df2 = df.dropDuplicates("_VALUE")
      .select($"_VALUE", $"_orcid")
      .cache()
    println(df2.count())
    df2.show(100)
    import com.mongodb.spark.config._

    MongoSpark.save(df2.write.option("collection", "Property.Author").mode("overwrite"))
  }
```



#  å®éªŒè®°å½• 2020-05-25

##ä¸€äº›mongodbæŸ¥è¯¢è¯­å¥çš„ä¾‹å­

æ ¹æ®å­—ç¬¦ä¸²å­—æ®µè¿›è¡Œæ­£åˆ™åŒ¹é…

```json
{'title': cloud}
```

æ ¹æ®å­—ç¬¦ä¸²å­—æ®µè¿›è¡Œæ­£åˆ™åŒ¹é…

```json
{'title': /cloud/i}
```

æ ¹æ®æ•°ç»„å†…çš„å…ƒç´ è¿›è¡Œç²¾ç¡®åŒ¹é…

```json
{'author._VALUE': "Joon Sun Park"}
```

æ ¹æ®æ•°ç»„å†…çš„å…ƒç´ è¿›è¡Œæ­£åˆ™åŒ¹é…

```json
{'author._VALUE': /Park/i}
```

æ ¹æ®æ•°ç»„å†…å…ƒç´ è¿›è¡Œä¸€ç»„æ­£åˆ™æ¡ä»¶çš„åŒ¹é…

```json
{
	'author._VALUE': {
		$in: [/Park/i, /Mike/i]
	}
}
```

# å®éªŒè®°å½• 2020-06-28

##UIå¯ä»¥ç”¨äº†

æˆ‘ä»¬å·²ç»å°†mongodb-SpringBoot-Vueè¿æ¥èµ·æ¥äº†ï¼Œæˆ‘ä»¬ç°åœ¨åªåšäº†articleæ–‡æ¡£çš„éƒ¨åˆ†æŸ¥è¯¢æ“ä½œã€‚

é€šè¿‡SpringDataMongoDBæ‰§è¡ŒæŸ¥è¯¢æ“ä½œã€‚

articleå®ä½“ç±»çš„å®šä¹‰

```java
package cn.jmu.spark_dblp.server.entity;

import cn.jmu.spark_dblp.server.entity.sub.*;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;
import org.springframework.data.mongodb.core.mapping.Field;

import java.util.List;

@Document(collection = "article")
@Data
public class Article {
    @Id
    protected String _id;
    @Field
    private String _cdate;
    @Field
    private String _key;
    @Field
    private String _mdate;
    @Field
    private String _publtype;
    @Field
    private List<property.Author> author;
    @Field
    private String booktitle;
    @Field
    private String cdrom;
    @Field
    private List<Cite> cite;
    @Field
    private String crossref;
    @Field
    private List<Editor> editor;
    @Field
    private List<Ee> ee;
    @Field
    private String journal;
    @Field
    private String month;
    @Field
    private List<Note> note;
    @Field
    private String publisher;
    @Field
    private String title;
    @Field
    private String url;
    @Field
    private String volume;
    @Field
    private Long year;
}
```

articleçš„æŸ¥è¯¢æ–¹æ³•ã€‚SpringDataç³»åˆ—çš„ORMæ¡†æ¶APIé£æ ¼ç»Ÿä¸€ï¼Œå¹¶ä¸”APIè®¾è®¡ä¸Šæœ‰Hibernateçš„å½±å­ã€‚è¿™ç»™äºˆåœ¨å†™ç®€å•æŸ¥è¯¢è¯­å¥æ—¶å¾ˆå¤§çš„æ–¹ä¾¿ã€‚

```java
package cn.jmu.spark_dblp.server.dao;

import cn.jmu.spark_dblp.server.entity.Article;
import cn.jmu.spark_dblp.server.entity.sub.Property.Author;
import org.springframework.data.mongodb.repository.Query;
import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Stream;

@Repository
public interface ArticleDAO extends CrudRepository<Article, String> {
  	//æ ¹æ®ä½œè€…è¿›è¡ŒåŒ¹é…ï¼Œè¿™ç§æŸ¥è¯¢æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°çš„è®¾ç½®æ¯”è¾ƒéº»çƒ¦ã€‚ä¸å¤ªå®ç”¨ä¸äºˆé‡‡ç”¨
    List<Article> findAllByAuthorContaining(List<property.Author> author);

  	//ä¸ä¸Šä¸€ä¸ªæŸ¥è¯¢æ–¹æ³•ç±»ä¼¼
    Stream<Article> findAllByAuthorContaining(property.Author author);

  	//è¿™ä¸ªæ˜¯æ‰‹å·¥è®¾å®šçš„MongoDBæŸ¥è¯¢è¯­å¥ï¼Œä½†æ˜¯ä»–è¿˜ç»“åˆäº†ä¸€äº›SpELåœ¨é‡Œé¢ã€‚
  	//ç›®å‰å¯¹articleä¸‰æ¡ä»¶æŸ¥è¯¢æ˜¯åŸºäºè¿™ä¸ªå®ç°çš„
  	//ç”±äºä¸‰ä¸ªæ¡ä»¶å¯èƒ½ç¼ºå¤±ï¼Œè¿™ä¸ªè¯­å¥å¾ˆä¸‘ï¼Œæˆ‘æ­£åœ¨å¯»æ±‚å†™å¾—å¥½çœ‹çš„æ–¹æ³•
  	//ç”±äºå¯èƒ½éœ€è¦å¯¹è¿”å›çš„æ•°æ®è¿›è¡Œç®€å•çš„è§„çº¦åå†ç»™å‰ç«¯ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ä¸€ä¸ªStream
    @Query("{" +
            "title: ?#{ [0].isEmpty() ?  {$exists :true} : {$regex: [0], $options: '$i'} }," +
            "'author._VALUE': ?#{ [1].size()==0 ?  {$exists :true} : {$in:[1]} }," +
            "'year': ?#{ [2].size()==0 ? {$exists :true} : {$in: [2]}  }"+
            "}")
    Stream<Article> findAllByTitleContainingAndAuthor__VALUEContainingAndYearIn(
            String title,
            List<Pattern> author,
            List<Integer> year
    );

  	//æ ¹æ®ä½œè€…çš„ç²¾ç¡®æŸ¥æ‰¾
    @Query("{'author._VALUE': ?0}")
    Stream<Article> findAllByAuthorContainingAccurate(String author);

  	//æ ¹æ®æ ‡é¢˜çš„æ¨¡ç³ŠæŸ¥æ‰¾ï¼Œæ²¡æ€ä¹ˆç”¨åˆ°
    @Query("{title: ?#{ [0].isEmpty() ?  abc : {$regex: [0], $options: '$i'} }}")
    Stream<Article> findAllByTitleContaining(String title);

}

```

Controlleréƒ¨åˆ†çš„æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œçœç•¥ã€‚ä»…è¯´æ˜éƒ¨åˆ†çš„http API

å¯¹articleè¿›è¡Œå¤šæ¡ä»¶ç­›é€‰ï¼ŒæŸ¥è¯¢æ¡ä»¶é€šè¿‡jsonä¼ è¾“

```
POST http://host:port/article/search
```

å¯¹ä½œè€…è¿›è¡Œç²¾ç¡®æœç´¢

```
GET http://host:port/article/accurateAuthor?author={}
```

å¯¹ä½œè€…è¿›è¡Œæ¨¡ç³Šæœç´¢

```
POST http://host:port/authors?_VALUE={}
```

## UIæ¼”ç¤ºå›¾ç‰‡

![æˆªå±2020-07-03 ä¸Šåˆ11.42.56](/Users/gaoxin/Library/Application Support/typora-user-images/æˆªå±2020-07-03 ä¸Šåˆ11.44.13.png)

![æˆªå±2020-07-03 ä¸Šåˆ11.46.02](/Users/gaoxin/Library/Application Support/typora-user-images/æˆªå±2020-07-03 ä¸Šåˆ11.46.02.png)

# å®éªŒè®°å½• 2020-06-30

å‘ç°æäº¤è¿”å›è¾ƒå¤šç»“æœçš„æŸ¥è¯¢ï¼ˆå¤§çº¦500æ¡è¿”å›ç»“æœï¼‰æ—¶å»¶è¿Ÿæ—¶é—´å·²ç»é•¿åˆ°æ— æ³•å®¹å¿ï¼Œæ’æŸ¥åå‘ç°ä¸»è¦çš„æ—¶é—´æ¶ˆè€—åœ¨å¯¹å¤§é‡æ•°æ®çš„ä¼ è¾“ä¸Šã€‚æˆ‘ä»¬ç›®å‰æ‰“ç®—è¿›è¡Œåˆ†é¡µå¤„ç†ï¼Œé™åˆ¶è¿”å›çš„ç»“æœã€‚

# å®éªŒè®°å½• 2020-07-13

æˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç±»ï¼Œåˆ†ç±»å…³é”®å­—æ˜¯æ¯ä¸ªå­èŠ‚ç‚¹çš„åç§°å’Œ_publitypeå±æ€§ã€‚åœ¨æ­¤è®°å½•å¯¼å…¥å„ä¸ªå­èŠ‚ç‚¹çš„mongodbé›†åˆçš„groupè¿ç®—ç»“æœã€‚

##article

```json
[
  {
    "prefix1": "journals/",
    "_publtype": "informal"
  },
  {
    "prefix1": "journals/",
    "_publtype": "edited"
  },
  {
    "prefix1": "journals/",
    "_publtype": "data"
  },
  {
    "prefix1": "journals/",
    "_publtype": "software"
  },
  {
    "prefix1": "journals/"
  },
  {
    "prefix1": "journals/",
    "_publtype": "survey"
  },
  {
    "prefix1": "journals/",
    "_publtype": "informal withdrawn"
  },
  {
    "prefix1": "conf/"
  },
  {
    "prefix1": "tr/",
    "_publtype": "informal"
  },
  {
    "prefix1": "dblpnote/",
    "_publtype": "informal"
  },
  {
    "prefix1": "journals/",
    "_publtype": "withdrawn"
  },
  {
    "prefix1": "persons/",
    "_publtype": "informal"
  },
  {
    "prefix1": "persons/"
  }
]
```

## book

```json
[
  {
    "prefix1": "phd/"
  },
  {
    "prefix1": "tr/"
  },
  {
    "prefix1": "persons/"
  },
  {
    "prefix1": "conf/"
  },
  {
    "prefix1": "books/",
    "_publtype": "habil"
  },
  {
    "prefix1": "phd/",
    "_publtype": "habil"
  },
  {
    "prefix1": "series/",
    "_publtype": "informal"
  },
  {
    "prefix1": "series/"
  },
  {
    "prefix1": "series/",
    "_publtype": "withdrawn"
  },
  {
    "prefix1": "books/"
  },
  {
    "prefix1": "reference/"
  }
]
```

## incollection

```json
[
  {
    "prefix1": "series/"
  },
  {
    "prefix1": "conf/"
  },
  {
    "prefix1": "books/"
  },
  {
    "prefix1": "journals/"
  },
  {
    "prefix1": "reference/"
  },
  {
    "prefix1": "books/",
    "_publtype": "encyclopedia"
  },
  {
    "prefix1": "reference/",
    "_publtype": "encyclopedia"
  },
  {
    "prefix1": "series/",
    "_publtype": "withdrawn"
  },
  {
    "prefix1": "series/",
    "_publtype": "encyclopedia"
  }
]
```

## inproceedings

```json
[
  {
    "prefix1": "series/"
  },
  {
    "prefix1": "conf/"
  },
  {
    "prefix1": "journals/"
  },
  {
    "prefix1": "www/"
  },
  {
    "prefix1": "persons/"
  },
  {
    "prefix1": "conf/",
    "_publtype": "withdrawn"
  },
  {
    "prefix1": "conf/",
    "_publtype": "informal"
  },
  {
    "prefix1": "journals/",
    "_publtype": "informal"
  },
  {
    "prefix1": "journals/",
    "_publtype": "withdrawn"
  }
]
```



## masterthesis

```json
[
  {
    "prefix1": "ms/"
  },
  {
    "prefix1": "phd/"
  }
]
```

## phdthesis

```json
[
  {
    "prefix1": "phd/"
  },
  {
    "prefix1": "series/"
  },
  {
    "prefix1": "books/"
  },
  {
    "prefix1": "phd/",
    "_publtype": "withdrawn"
  }
]
```

## proceedings

```json
[
  {
    "prefix1": "conf/",
    "_publtype": "withdrawn"
  },
  {
    "prefix1": "tr/",
    "_publtype": "informal"
  },
  {
    "prefix1": "conf/"
  },
  {
    "prefix1": "journals/"
  },
  {
    "prefix1": "reference/"
  },
  {
    "prefix1": "books/"
  },
  {
    "prefix1": "series/"
  }
]
```

## all InOne

```json
[
  {
    "prefix1": "reference/",
    "_publtype": "encyclopedia",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "series/",
    "_publtype": "withdrawn",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "books/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "reference/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "tr/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "_publtype": "edited",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "conf/",
    "_publtype": "withdrawn",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "phd/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "books/",
    "_publtype": "encyclopedia",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "conf/",
    "_publtype": "informal",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "_publtype": "informal",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "dblpnote/",
    "_publtype": "informal",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "tr/",
    "_publtype": "informal",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "series/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "_publtype": "data",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "series/",
    "_publtype": "informal",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "series/",
    "_publtype": "encyclopedia",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "ms/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "persons/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "www/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "phd/",
    "_publtype": "withdrawn",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "conf/",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "_publtype": "survey",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "_publtype": "withdrawn",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "phd/",
    "_publtype": "habil",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "books/",
    "_publtype": "habil",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "persons/",
    "_publtype": "informal",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "_publtype": "software",
    "type_xml": "type_xml"
  },
  {
    "prefix1": "journals/",
    "_publtype": "informal withdrawn",
    "type_xml": "type_xml"
  }
]
```

#å®éªŒè®°å½• 2020-07-14 é’ˆå¯¹æ¨¡ç³ŠåŒ¹é…çš„ç´¢å¼•ç­–ç•¥

éœ€æ±‚æè¿°ï¼šç½‘ç«™ç”¨æˆ·éœ€è¦æ ¹æ®æ–‡ç« æ ‡é¢˜æŸ¥è¯¢è·å–æ•°æ®åº“ä¸­çš„è®ºæ–‡

é—®é¢˜æè¿°ï¼šmongodbæ•°æ®åº“ä¸­çš„onlyDocé›†åˆæ˜¯å°†articleã€inproceedingsã€proceedingsã€bookã€incollectionã€phdthesisã€mastersthesisè¿›è¡Œåˆå¹¶å½¢æˆçš„é›†åˆã€‚æ–‡æ¡£æ€»æ•°ä¸º5,146,977ã€‚onlyDocå­˜æ”¾æ–‡ç« æ ‡é¢˜çš„å­—æ®µæ˜¯titleï¼Œè¯¥å­—æ®µå­˜æ”¾çš„æ•°æ®ç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚ç”±äºç½‘ç«™çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬æ–‡ç« æŸ¥è¯¢ï¼Œè¯¥æ¥å£è¢«è°ƒç”¨çš„é¢‘ç‡æé«˜ã€‚ä¸æé«˜çš„è°ƒç”¨é¢‘ç‡æ‰€ä¸ç¬¦çš„æ˜¯ï¼Œè¯¥æ¥å£å¯¹åº”çš„æ•°æ®åº“æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œå¼€é”€ç”šè‡³é«˜äº10sã€‚è¿™ç§ä¸åŒ¹é…å¯¹ç”¨æˆ·ä½“éªŒå’ŒæœåŠ¡å™¨å‹åŠ›éƒ½äº§ç”Ÿäº†è´Ÿé¢å½±å“ï¼Œéå¸¸éœ€è¦ä¼˜åŒ–ã€‚

è§£å†³æ–¹æ¡ˆï¼šé’ˆå¯¹titleå»ºç«‹ç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•ä¼˜åŒ–æ–¹æ³•ï¼Œå‡å°‘ç£ç›˜IOå¼€é”€ä»è€Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚

è¯„ä¼°æ–¹æ³•ï¼šæˆ‘ä»¬é€‰å®šäº†å‡ ç§æŸ¥è¯¢èƒ½å¤Ÿå®Œæˆè¿™ä¸ªéœ€æ±‚çš„æŸ¥è¯¢ï¼Œé€šè¿‡mongodbçš„explain()APIä»¥åŠæŸ¥è¯¢å®Œæˆåçš„å®é™…ç»“æœè¯„ä¼°æŸ¥è¯¢æ—¶é—´å¼€é”€ã€‚ä¸»è¦é€šè¿‡ä¸‹åˆ—æŒ‡æ ‡è¯„ä¼°æŸ¥è¯¢çš„æ€§èƒ½ï¼š

1. executionTimeMillisï¼šæŸ¥è¯¢æ‰§è¡Œæ—¶é—´
2. totalDocsExaminedï¼šæ€»å…±æ£€éªŒçš„æ–‡æ¡£æ•°é‡
3. totalKeysExaminedï¼šæ€»å…±æ£€éªŒçš„keyæ•°é‡
4. totalReturnï¼šæŸ¥è¯¢å®Œæˆåæ€»å…±è¿”å›çš„æ–‡æ¡£æ•°é‡
5. totalTimeï¼šæŸ¥è¯¢å®Œæˆåè¿”å›ç»“æœè€—è´¹çš„æ€»æ—¶é—´

å…¶ä¸­1ã€2ã€3æ˜¯mongodbæä¾›çš„explain()APIè¿”å›çš„å‚æ•°ï¼Œexplain()æ‰§è¡Œçš„çš„æ˜¯findFirsté€»è¾‘ï¼Œä¹Ÿå°±æ˜¯è¯´explain()çš„æŸ¥è¯¢ç»“æœéƒ½æ˜¯ä»¥**åªè¿”å›1ä¸ª**æ–‡æ¡£ä½œä¸ºå‰æçš„ã€‚4ã€5æ˜¯mongodbçš„å›¾å½¢ç•Œé¢å·¥å…·é‡‡é›†çš„æ•°æ®ï¼Œæ‰§è¡Œçš„æ˜¯findAllé€»è¾‘ã€‚è¿™æ˜¯ä»¥æŸ¥è¯¢è¯­å¥**è¿”å›æ‰€æœ‰æˆåŠŸåŒ¹é…çš„ç»“æœ**çš„æ¡ä»¶ä¸‹è·å–çš„å‚æ•°ã€‚

## æœªå»ºç«‹ä»»ä½•ç´¢å¼•

### æŸ¥è¯¢åˆ†æå‘½ä»¤ç»“æœ

`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`æ˜¯ä¸€ä¸ªå¸¸è§çš„æŸ¥è¯¢ï¼Œæ ¹æ®titleè¿›è¡Œæ¨¡ç³ŠåŒ¹é…å¹¶æ ¹æ®yearæ’åºã€‚

æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ­£åˆ™åŒ¹é…`/spark/i`ä½œä¸ºæŸ¥è¯¢å…³é”®å­—

æŸ¥è¯¢å‘½ä»¤ï¼š`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`

æ˜¾ç¤ºæŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’å‘½ä»¤ï¼š`db.onlyDoc.explain("allPlansExecution").find({title: /spark/i}).sort({year: 1})`

```json
[
  {
    "executionStats": {
      "executionSuccess": true,
      "nReturned": 1,
      "executionTimeMillis": 31866,
      "totalKeysExamined": 0,
      "totalDocsExamined": 5146977,
      "executionStages": {
        "stage": "SORT",
        "nReturned": 1,
        "executionTimeMillisEstimate": 3752,
        "works": 5146982,
        "advanced": 1,
        "needTime": 5146980,
        "needYield": 0,
        "saveState": 40242,
        "restoreState": 40242,
        "isEOF": 1,
        "sortPattern": {
          "year": 1
        },
        "memUsage": 597,
        "memLimit": 33554432,
        "limitAmount": 1,
        "inputStage": {
          "stage": "SORT_KEY_GENERATOR",
          "nReturned": 1575,
          "executionTimeMillisEstimate": 3716,
          "works": 5146980,
          "advanced": 1575,
          "needTime": 5145404,
          "needYield": 0,
          "saveState": 40242,
          "restoreState": 40242,
          "isEOF": 1,
          "inputStage": {
            "stage": "COLLSCAN",
            "filter": {
              "title": {
                "$regex": "spark",
                "$options": "i"
              }
            },
            "nReturned": 1575,
            "executionTimeMillisEstimate": 3706,
            "works": 5146979,
            "advanced": 1575,
            "needTime": 5145403,
            "needYield": 0,
            "saveState": 40242,
            "restoreState": 40242,
            "isEOF": 1,
            "direction": "forward",
            "docsExamined": 5146977
          }
        }
      },
      "allPlansExecution": []
    },
    "ok": 1,
    "queryPlanner": {
      "plannerVersion": 1,
      "namespace": "SparkDBLPTest.onlyDoc",
      "indexFilterSet": false,
      "parsedQuery": {
        "title": {
          "$regex": "spark",
          "$options": "i"
        }
      },
      "winningPlan": {
        "stage": "SORT",
        "sortPattern": {
          "year": 1
        },
        "limitAmount": 1,
        "inputStage": {
          "stage": "SORT_KEY_GENERATOR",
          "inputStage": {
            "stage": "COLLSCAN",
            "filter": {
              "title": {
                "$regex": "spark",
                "$options": "i"
              }
            },
            "direction": "forward"
          }
        }
      },
      "rejectedPlans": []
    },
    "serverInfo": {
      "host": "51c90cc27037",
      "port": 27017,
      "version": "4.2.6",
      "gitVersion": "20364840b8f1af16917e4c23c1b5f5efd8b352f8"
    }
  }
]
```

æŸ¥è¯¢å‘½ä»¤ï¼š`db.onlyDoc.find({title: /spark/i})`

æ˜¾ç¤ºæŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’å‘½ä»¤ï¼š`db.onlyDoc.explain("allPlansExecution").find({title: /spark/i})`

```json
[
  {
    "executionStats": {
      "executionSuccess": true,
      "nReturned": 1,
      "executionTimeMillis": 406,
      "totalKeysExamined": 0,
      "totalDocsExamined": 1484,
      "executionStages": {
        "stage": "LIMIT",
        "nReturned": 1,
        "executionTimeMillisEstimate": 298,
        "works": 1486,
        "advanced": 1,
        "needTime": 1484,
        "needYield": 0,
        "saveState": 14,
        "restoreState": 14,
        "isEOF": 1,
        "limitAmount": 1,
        "inputStage": {
          "stage": "COLLSCAN",
          "filter": {
            "title": {
              "$regex": "spark",
              "$options": "i"
            }
          },
          "nReturned": 1,
          "executionTimeMillisEstimate": 298,
          "works": 1485,
          "advanced": 1,
          "needTime": 1484,
          "needYield": 0,
          "saveState": 14,
          "restoreState": 14,
          "isEOF": 0,
          "direction": "forward",
          "docsExamined": 1484
        }
      },
      "allPlansExecution": []
    },
    "ok": 1,
    "queryPlanner": {
      "plannerVersion": 1,
      "namespace": "SparkDBLPTest.onlyDoc",
      "indexFilterSet": false,
      "parsedQuery": {
        "title": {
          "$regex": "spark",
          "$options": "i"
        }
      },
      "winningPlan": {
        "stage": "LIMIT",
        "limitAmount": 1,
        "inputStage": {
          "stage": "COLLSCAN",
          "filter": {
            "title": {
              "$regex": "spark",
              "$options": "i"
            }
          },
          "direction": "forward"
        }
      },
      "rejectedPlans": []
    },
    "serverInfo": {
      "host": "51c90cc27037",
      "port": 27017,
      "version": "4.2.6",
      "gitVersion": "20364840b8f1af16917e4c23c1b5f5efd8b352f8"
    }
  }
]
```



###åˆ†æ

`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`æ˜¯ä¸€ä¸ªå…¸å‹çš„æŸ¥è¯¢è¯­å¥ï¼Œæ ¹æ®æ‰§è¡Œè®¡åˆ’æ˜¾ç¤ºçš„å†…å®¹

> executionTimeMillis:31866
>
> totalKeysExamined:0
>
> totalDocsExamined:5146977
>
> totalReturn:1575
>
> totalTime:29s 521ms

è¯¥æŸ¥è¯¢è¯­å¥è€—è´¹äº†å¤§é‡æ—¶é—´ï¼Œæ€»å…±æ‰§è¡Œæ—¶é—´å¤§çº¦31ç§’ã€‚é€ æˆå¤§é‡æ—¶é—´è€—è´¹çš„æ˜¯åŸå› æ˜¯æ’åºæ“ä½œé¢‘ç¹çš„è¿›è¡ŒIOã€‚æ‰§è¡Œé˜¶æ®µä¸ºå¦‚ä¸‹ä¸‰ä¸ªè¿‡ç¨‹

```mermaid
graph LR;
  COLLSCAN-->SORT_KEY_GENERATOR
  SORT_KEY_GENERATOR-->SORT
```

```mermaid
pie
    title å„é˜¶æ®µæ‰§è¡Œè€—æ—¶ä¼°è®¡æ¯”ä¾‹
    "SORT" : 3752
    "SORT_KEY_GENERATOR" : 3716
    "COLLSCAN" : 3706
```

ç›¸æ¯”ä¹‹ä¸‹ï¼Œä¸éœ€è¦æ‰§è¡Œæ’åºæ“ä½œçš„æŸ¥è¯¢ï¼Œ`db.onlyDoc.find({title: /spark/})`çš„æ‰§è¡Œå´èŠ±è´¹äº†æå°‘æ—¶é—´ã€‚æŒ‰ç…§æ‰§è¡Œé˜¶æ®µçš„ä¼°è®¡å€¼æ¥çœ‹ï¼Œè¯¥æŸ¥è¯¢åº”è¯¥ä¹Ÿéœ€è¦èŠ±è´¹å¤§çº¦10ç§’çš„æ—¶é—´ã€‚ä½†æ˜¯å®é™…ä¸ŠèŠ±è´¹çš„æ—¶é—´å´éå¸¸å°‘

> executionTimeMillis:406
>
> totalKeysExamined:0
>
> totalDocsExamined:1484
>
> totalReturn:1575
>
> totalTime:27s 883ms

åŸå› æ˜¯è¯¥æŸ¥è¯¢æ‰§è¡Œäº†ä¸¤ä¸ªé˜¶æ®µ

```mermaid
graph LR;
  LIMIT-->COLLSCAN
```

ç”±äºåªéœ€è¦è·å–è¾ƒå°‘æ•°é‡çš„ç»“æœï¼ˆç”±LIMITé˜¶æ®µå†³å®šè¿™ä¸ªç»“æœçš„æ•°é‡ï¼‰å¹¶ä¸”ä¸éœ€è¦è¿›è¡Œæ’åºæ“ä½œï¼Œè¡¨æ‰«æï¼ˆCOLLSCANï¼‰é˜¶æ®µåªéœ€è¦èŠ±è´¹å¾ˆå°‘çš„æ—¶é—´ï¼Œæœé›†åˆ°æ»¡è¶³LIMITé˜¶æ®µæ‰€è§„å®šæ•°é‡çš„æ–‡æ¡£å°±å¯ä»¥å®ŒæˆæŸ¥è¯¢ä»»åŠ¡ã€‚æ ¹æ®totalDocsExaminedä¹Ÿå¯ä»¥ç¡®å®šï¼Œæ•°æ®åº“ä»…ä»…æ£€éªŒäº†1484ä¸ªæ–‡æ¡£å°±è¿”å›äº†ï¼Œå…¶ç»“æœè¿œå°äº5146977ä¸ªæ–‡æ¡£ï¼ˆ5146977æ˜¯ä¸å»ºç«‹ç´¢å¼•æ‰§è¡Œå¸¦æœ‰æ’åºæ“ä½œçš„totalDocsExaminedå€¼ï¼‰ã€‚

###ç»“è®º

å¯ä»¥é€šè¿‡é¿å…æ’åºæ“ä½œï¼ŒåŒæ—¶å‡å°‘è¿”å›ç»“æœçš„æ•°é‡è§„é¿æŸ¥è¯¢æ—¶é—´å¼€é”€å¤§çš„é—®é¢˜

##yearå­—æ®µå»ºç«‹å•å€¼ç´¢å¼•

æ ¹æ®titleï¼ˆæœªå»ºç«‹ä»»ä½•ç´¢å¼•ï¼‰çš„æŸ¥è¯¢åˆ†æç»“æœï¼Œ`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`çš„æ—¶é—´çº¦66%èŠ±è´¹åœ¨æ’åºä¸Šã€‚å› æ­¤æƒ³åˆ°åœ¨yearå»ºç«‹ç´¢å¼•ã€‚

### æŸ¥è¯¢åˆ†æå‘½ä»¤ç»“æœ

æŸ¥è¯¢å‘½ä»¤ï¼š`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`

æ˜¾ç¤ºæŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’å‘½ä»¤ï¼š`db.onlyDoc.explain("allPlansExecution").find({title: /spark/i}).sort({year: 1})`

```json
[
  {
    "executionStats": {
      "executionSuccess": true,
      "nReturned": 1,
      "executionTimeMillis": 67,
      "totalKeysExamined": 4524,
      "totalDocsExamined": 4524,
      "executionStages": {
        "stage": "LIMIT",
        "nReturned": 1,
        "executionTimeMillisEstimate": 8,
        "works": 4525,
        "advanced": 1,
        "needTime": 4523,
        "needYield": 0,
        "saveState": 35,
        "restoreState": 35,
        "isEOF": 1,
        "limitAmount": 1,
        "inputStage": {
          "stage": "FETCH",
          "filter": {
            "title": {
              "$regex": "spark",
              "$options": "i"
            }
          },
          "nReturned": 1,
          "executionTimeMillisEstimate": 8,
          "works": 4524,
          "advanced": 1,
          "needTime": 4523,
          "needYield": 0,
          "saveState": 35,
          "restoreState": 35,
          "isEOF": 0,
          "docsExamined": 4524,
          "alreadyHasObj": 0,
          "inputStage": {
            "stage": "IXSCAN",
            "nReturned": 4524,
            "executionTimeMillisEstimate": 2,
            "works": 4524,
            "advanced": 4524,
            "needTime": 0,
            "needYield": 0,
            "saveState": 35,
            "restoreState": 35,
            "isEOF": 0,
            "keyPattern": {
              "year": 1
            },
            "indexName": "year_1",
            "isMultiKey": false,
            "multiKeyPaths": {
              "year": []
            },
            "isUnique": false,
            "isSparse": false,
            "isPartial": false,
            "indexVersion": 2,
            "direction": "forward",
            "indexBounds": {
              "year": ["[MinKey, MaxKey]"]
            },
            "keysExamined": 4524,
            "seeks": 1,
            "dupsTested": 0,
            "dupsDropped": 0
          }
        }
      },
      "allPlansExecution": []
    },
    "ok": 1,
    "queryPlanner": {
      "plannerVersion": 1,
      "namespace": "SparkDBLPTest.onlyDoc",
      "indexFilterSet": false,
      "parsedQuery": {
        "title": {
          "$regex": "spark",
          "$options": "i"
        }
      },
      "winningPlan": {
        "stage": "LIMIT",
        "limitAmount": 1,
        "inputStage": {
          "stage": "FETCH",
          "filter": {
            "title": {
              "$regex": "spark",
              "$options": "i"
            }
          },
          "inputStage": {
            "stage": "IXSCAN",
            "keyPattern": {
              "year": 1
            },
            "indexName": "year_1",
            "isMultiKey": false,
            "multiKeyPaths": {
              "year": []
            },
            "isUnique": false,
            "isSparse": false,
            "isPartial": false,
            "indexVersion": 2,
            "direction": "forward",
            "indexBounds": {
              "year": ["[MinKey, MaxKey]"]
            }
          }
        }
      },
      "rejectedPlans": []
    },
    "serverInfo": {
      "host": "7f0809e8d55d",
      "port": 27017,
      "version": "4.2.8",
      "gitVersion": "43d25964249164d76d5e04dd6cf38f6111e21f5f"
    }
  }
]
```

### åˆ†æ

findFirsté€»è¾‘ä¸‹ï¼Œ`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`ç”±äºyearå­—æ®µä¸Šç´¢å¼•çš„å»ºç«‹ï¼Œé¿å…äº†å…¨è¡¨æ‰«æã€‚æŸ¥è¯¢æ€»æ—¶é—´ä»ã€‚ä½†æ˜¯åœ¨findAllé€»è¾‘ä¸‹ï¼Œåè€Œæ¯”æœªå»ºç«‹ç´¢å¼•èŠ±è´¹äº†æ›´å¤šæ—¶é—´ã€‚

**31866æ˜¾è‘—é™ä½åˆ°67**ã€‚

> executionTimeMillis:67
>
> totalKeysExamined:4524
>
> totalDocsExamined:4524
>
> totalReturn:1575
>
> totalTime:1m 38s 367ms

è¯¥æŸ¥è¯¢è¯­å¥æ‰§è¡Œé˜¶æ®µä¸ºå¦‚ä¸‹ä¸‰ä¸ªè¿‡ç¨‹

```mermaid
graph LR;
  IXSCAN-->FETCH
  FETCH-->LIMIT
```

```mermaid
pie
    title å„é˜¶æ®µæ‰§è¡Œè€—æ—¶ä¼°è®¡æ¯”ä¾‹
    "IXSCAN" : 0
    "FETCH" : 5
    "LIMIT" : 5
```

ç”±äºåœ¨yearå»ºç«‹çš„ç´¢å¼•ï¼Œæ’åºæ“ä½œé€šè¿‡æ‰§è¡Œç´¢å¼•æ‰«æï¼ˆIXSCANï¼‰åœ¨å¾ˆçŸ­æ—¶é—´å†…å°±å®Œæˆäº†ã€‚ä¸»è¦çš„æ—¶é—´éƒ½èŠ±è´¹åœ¨æ ¹æ®æ’åºç»“æœå¯»æ‰¾å¯¹åº”æ•°æ®ä¸Šã€‚

###ç»“è®º

åœ¨æ‰§è¡ŒfindFirsté€»è¾‘æ—¶å¯ä»¥é€šè¿‡åœ¨æ’åºå…³é”®å­—å»ºç«‹ç´¢å¼•æ˜¾è‘—å¢åŠ å¸¦æ’åºæ“ä½œçš„æŸ¥è¯¢çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†æ˜¯åœ¨findAllé€»è¾‘ä¸‹yearä¸Šå»ºç«‹çš„ç´¢å¼•äº§ç”Ÿäº†è´Ÿä¼˜åŒ–çš„æ•ˆæœã€‚

##titleå»ºç«‹å•å€¼ç´¢å¼•ï¼Œyearå»ºç«‹å•å€¼ç´¢å¼•

### æŸ¥è¯¢åˆ†æå‘½ä»¤ç»“æœ

æŸ¥è¯¢å‘½ä»¤ï¼š`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`

æ˜¾ç¤ºæŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’å‘½ä»¤ï¼š`db.onlyDoc.explain("allPlansExecution").find({title: /spark/i}).sort({year: 1})`

```json
[
  {
    "executionStats": {
      "executionSuccess": true,
      "nReturned": 1,
      "executionTimeMillis": 84,
      "totalKeysExamined": 4524,
      "totalDocsExamined": 4524,
      "executionStages": {
        "stage": "LIMIT",
        "nReturned": 1,
        "executionTimeMillisEstimate": 8,
        "works": 4525,
        "advanced": 1,
        "needTime": 4523,
        "needYield": 0,
        "saveState": 70,
        "restoreState": 70,
        "isEOF": 1,
        "limitAmount": 1,
        "inputStage": {
          "stage": "FETCH",
          "filter": {
            "title": {
              "$regex": "spark",
              "$options": "i"
            }
          },
          "nReturned": 1,
          "executionTimeMillisEstimate": 8,
          "works": 4524,
          "advanced": 1,
          "needTime": 4523,
          "needYield": 0,
          "saveState": 70,
          "restoreState": 70,
          "isEOF": 0,
          "docsExamined": 4524,
          "alreadyHasObj": 0,
          "inputStage": {
            "stage": "IXSCAN",
            "nReturned": 4524,
            "executionTimeMillisEstimate": 1,
            "works": 4524,
            "advanced": 4524,
            "needTime": 0,
            "needYield": 0,
            "saveState": 70,
            "restoreState": 70,
            "isEOF": 0,
            "keyPattern": {
              "year": 1
            },
            "indexName": "year_1",
            "isMultiKey": false,
            "multiKeyPaths": {
              "year": []
            },
            "isUnique": false,
            "isSparse": false,
            "isPartial": false,
            "indexVersion": 2,
            "direction": "forward",
            "indexBounds": {
              "year": ["[MinKey, MaxKey]"]
            },
            "keysExamined": 4524,
            "seeks": 1,
            "dupsTested": 0,
            "dupsDropped": 0
          }
        }
      },
      "allPlansExecution": [
        {
          "nReturned": 1,
          "executionTimeMillisEstimate": 8,
          "totalKeysExamined": 4524,
          "totalDocsExamined": 4524,
          "executionStages": {
            "stage": "LIMIT",
            "nReturned": 1,
            "executionTimeMillisEstimate": 8,
            "works": 4524,
            "advanced": 1,
            "needTime": 4523,
            "needYield": 0,
            "saveState": 70,
            "restoreState": 70,
            "isEOF": 1,
            "limitAmount": 1,
            "inputStage": {
              "stage": "FETCH",
              "filter": {
                "title": {
                  "$regex": "spark",
                  "$options": "i"
                }
              },
              "nReturned": 1,
              "executionTimeMillisEstimate": 8,
              "works": 4524,
              "advanced": 1,
              "needTime": 4523,
              "needYield": 0,
              "saveState": 70,
              "restoreState": 70,
              "isEOF": 0,
              "docsExamined": 4524,
              "alreadyHasObj": 0,
              "inputStage": {
                "stage": "IXSCAN",
                "nReturned": 4524,
                "executionTimeMillisEstimate": 1,
                "works": 4524,
                "advanced": 4524,
                "needTime": 0,
                "needYield": 0,
                "saveState": 70,
                "restoreState": 70,
                "isEOF": 0,
                "keyPattern": {
                  "year": 1
                },
                "indexName": "year_1",
                "isMultiKey": false,
                "multiKeyPaths": {
                  "year": []
                },
                "isUnique": false,
                "isSparse": false,
                "isPartial": false,
                "indexVersion": 2,
                "direction": "forward",
                "indexBounds": {
                  "year": ["[MinKey, MaxKey]"]
                },
                "keysExamined": 4524,
                "seeks": 1,
                "dupsTested": 0,
                "dupsDropped": 0
              }
            }
          }
        },
        {
          "nReturned": 0,
          "executionTimeMillisEstimate": 0,
          "totalKeysExamined": 4523,
          "totalDocsExamined": 0,
          "executionStages": {
            "stage": "SORT",
            "nReturned": 0,
            "executionTimeMillisEstimate": 0,
            "works": 4524,
            "advanced": 0,
            "needTime": 4524,
            "needYield": 0,
            "saveState": 70,
            "restoreState": 70,
            "isEOF": 0,
            "sortPattern": {
              "year": 1
            },
            "memUsage": 0,
            "memLimit": 33554432,
            "limitAmount": 1,
            "inputStage": {
              "stage": "SORT_KEY_GENERATOR",
              "nReturned": 0,
              "executionTimeMillisEstimate": 0,
              "works": 4524,
              "advanced": 0,
              "needTime": 4524,
              "needYield": 0,
              "saveState": 70,
              "restoreState": 70,
              "isEOF": 0,
              "inputStage": {
                "stage": "FETCH",
                "nReturned": 0,
                "executionTimeMillisEstimate": 0,
                "works": 4523,
                "advanced": 0,
                "needTime": 4523,
                "needYield": 0,
                "saveState": 70,
                "restoreState": 70,
                "isEOF": 0,
                "docsExamined": 0,
                "alreadyHasObj": 0,
                "inputStage": {
                  "stage": "IXSCAN",
                  "filter": {
                    "title": {
                      "$regex": "spark",
                      "$options": "i"
                    }
                  },
                  "nReturned": 0,
                  "executionTimeMillisEstimate": 0,
                  "works": 4523,
                  "advanced": 0,
                  "needTime": 4523,
                  "needYield": 0,
                  "saveState": 70,
                  "restoreState": 70,
                  "isEOF": 0,
                  "keyPattern": {
                    "title": 1
                  },
                  "indexName": "title_1",
                  "isMultiKey": false,
                  "multiKeyPaths": {
                    "title": []
                  },
                  "isUnique": false,
                  "isSparse": false,
                  "isPartial": false,
                  "indexVersion": 2,
                  "direction": "forward",
                  "indexBounds": {
                    "title": ["[\"\", {})", "[/spark/i, /spark/i]"]
                  },
                  "keysExamined": 4523,
                  "seeks": 1,
                  "dupsTested": 0,
                  "dupsDropped": 0
                }
              }
            }
          }
        }
      ]
    },
    "ok": 1,
    "queryPlanner": {
      "plannerVersion": 1,
      "namespace": "SparkDBLPTest.onlyDoc",
      "indexFilterSet": false,
      "parsedQuery": {
        "title": {
          "$regex": "spark",
          "$options": "i"
        }
      },
      "winningPlan": {
        "stage": "LIMIT",
        "limitAmount": 1,
        "inputStage": {
          "stage": "FETCH",
          "filter": {
            "title": {
              "$regex": "spark",
              "$options": "i"
            }
          },
          "inputStage": {
            "stage": "IXSCAN",
            "keyPattern": {
              "year": 1
            },
            "indexName": "year_1",
            "isMultiKey": false,
            "multiKeyPaths": {
              "year": []
            },
            "isUnique": false,
            "isSparse": false,
            "isPartial": false,
            "indexVersion": 2,
            "direction": "forward",
            "indexBounds": {
              "year": ["[MinKey, MaxKey]"]
            }
          }
        }
      },
      "rejectedPlans": [
        {
          "stage": "SORT",
          "sortPattern": {
            "year": 1
          },
          "limitAmount": 1,
          "inputStage": {
            "stage": "SORT_KEY_GENERATOR",
            "inputStage": {
              "stage": "FETCH",
              "inputStage": {
                "stage": "IXSCAN",
                "filter": {
                  "title": {
                    "$regex": "spark",
                    "$options": "i"
                  }
                },
                "keyPattern": {
                  "title": 1
                },
                "indexName": "title_1",
                "isMultiKey": false,
                "multiKeyPaths": {
                  "title": []
                },
                "isUnique": false,
                "isSparse": false,
                "isPartial": false,
                "indexVersion": 2,
                "direction": "forward",
                "indexBounds": {
                  "title": ["[\"\", {})", "[/spark/i, /spark/i]"]
                }
              }
            }
          }
        }
      ]
    },
    "serverInfo": {
      "host": "7f0809e8d55d",
      "port": 27017,
      "version": "4.2.8",
      "gitVersion": "43d25964249164d76d5e04dd6cf38f6111e21f5f"
    }
  }
]
```

### åˆ†æ

å¯ä»¥çœ‹å‡ºï¼Œ`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`æ²¡æœ‰ç”±äºtitleå­—æ®µä¸Šçš„å•å€¼ç´¢å¼•çš„å»ºç«‹ï¼Œæ˜¾è‘—å‡å°‘æŸ¥è¯¢æ€»æ—¶é—´ã€‚è™½ç„¶æŸ¥è¯¢è®¡åˆ’ç”±ä½¿ç”¨titleçš„ç´¢å¼•çš„æ‰“ç®—ï¼Œä½†æ˜¯æ‰§è¡Œæ—¶å¹¶æ²¡æœ‰ä½¿ç”¨titleä¸Šçš„å•å€¼ç´¢å¼•ã€‚

> executionTimeMillis:84
>
> totalKeysExamined:4524
>
> totalDocsExamined:4524
>
> totalReturn:1575
>
> totalTime:1m 47s 933ms



## ä»…titleå»ºç«‹å•å€¼ç´¢å¼•

###æŸ¥è¯¢åˆ†æå‘½ä»¤ç»“æœ

æŸ¥è¯¢å‘½ä»¤ï¼š`db.onlyDoc.find({title: /spark/i}).sort({year: 1})`

æ˜¾ç¤ºæŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’å‘½ä»¤ï¼š`db.onlyDoc.explain("allPlansExecution").find({title: /spark/i}).sort({year: 1})`

```json
[
  {
    "executionStats": {
      "executionSuccess": true,
      "nReturned": 1,
      "executionTimeMillis": 26635,
      "totalKeysExamined": 5146977,
      "totalDocsExamined": 1575,
      "executionStages": {
        "stage": "SORT",
        "nReturned": 1,
        "executionTimeMillisEstimate": 2236,
        "works": 5146981,
        "advanced": 1,
        "needTime": 5146979,
        "needYield": 0,
        "saveState": 40218,
        "restoreState": 40218,
        "isEOF": 1,
        "sortPattern": {
          "year": 1
        },
        "memUsage": 759,
        "memLimit": 33554432,
        "limitAmount": 1,
        "inputStage": {
          "stage": "SORT_KEY_GENERATOR",
          "nReturned": 1575,
          "executionTimeMillisEstimate": 2215,
          "works": 5146979,
          "advanced": 1575,
          "needTime": 5145403,
          "needYield": 0,
          "saveState": 40218,
          "restoreState": 40218,
          "isEOF": 1,
          "inputStage": {
            "stage": "FETCH",
            "nReturned": 1575,
            "executionTimeMillisEstimate": 2197,
            "works": 5146978,
            "advanced": 1575,
            "needTime": 5145402,
            "needYield": 0,
            "saveState": 40218,
            "restoreState": 40218,
            "isEOF": 1,
            "docsExamined": 1575,
            "alreadyHasObj": 0,
            "inputStage": {
              "stage": "IXSCAN",
              "filter": {
                "title": {
                  "$regex": "spark",
                  "$options": "i"
                }
              },
              "nReturned": 1575,
              "executionTimeMillisEstimate": 2065,
              "works": 5146978,
              "advanced": 1575,
              "needTime": 5145402,
              "needYield": 0,
              "saveState": 40218,
              "restoreState": 40218,
              "isEOF": 1,
              "keyPattern": {
                "title": 1
              },
              "indexName": "title_1",
              "isMultiKey": false,
              "multiKeyPaths": {
                "title": []
              },
              "isUnique": false,
              "isSparse": false,
              "isPartial": false,
              "indexVersion": 2,
              "direction": "forward",
              "indexBounds": {
                "title": ["[\"\", {})", "[/spark/i, /spark/i]"]
              },
              "keysExamined": 5146977,
              "seeks": 1,
              "dupsTested": 0,
              "dupsDropped": 0
            }
          }
        }
      },
      "allPlansExecution": []
    },
    "ok": 1,
    "queryPlanner": {
      "plannerVersion": 1,
      "namespace": "SparkDBLPTest.onlyDoc",
      "indexFilterSet": false,
      "parsedQuery": {
        "title": {
          "$regex": "spark",
          "$options": "i"
        }
      },
      "winningPlan": {
        "stage": "SORT",
        "sortPattern": {
          "year": 1
        },
        "limitAmount": 1,
        "inputStage": {
          "stage": "SORT_KEY_GENERATOR",
          "inputStage": {
            "stage": "FETCH",
            "inputStage": {
              "stage": "IXSCAN",
              "filter": {
                "title": {
                  "$regex": "spark",
                  "$options": "i"
                }
              },
              "keyPattern": {
                "title": 1
              },
              "indexName": "title_1",
              "isMultiKey": false,
              "multiKeyPaths": {
                "title": []
              },
              "isUnique": false,
              "isSparse": false,
              "isPartial": false,
              "indexVersion": 2,
              "direction": "forward",
              "indexBounds": {
                "title": ["[\"\", {})", "[/spark/i, /spark/i]"]
              }
            }
          }
        }
      },
      "rejectedPlans": []
    },
    "serverInfo": {
      "host": "7f0809e8d55d",
      "port": 27017,
      "version": "4.2.8",
      "gitVersion": "43d25964249164d76d5e04dd6cf38f6111e21f5f"
    }
  }
]
```

### åˆ†æ

ä»…å»ºç«‹titleçš„å•å€¼ç´¢å¼•æ—¶ï¼Œå¯¹äºæ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢ï¼Œæ—¶é—´æ²¡æœ‰å¾—åˆ°æ˜¾è‘—ä¼˜åŒ–ã€‚

> executionTimeMillis: 26635
>
> totalKeysExamined: 5146977
>
> totalDocsExamined: 1575
>
> nReturn:1575
>
> totalTime:23s 428ms

###ç»“è®º

å•å€¼ç´¢å¼•ä¸èƒ½å¾ˆå¥½çš„å¸®åŠ©åŒ¹é…æ¨¡ç³ŠæŸ¥è¯¢çš„è¯·æ±‚ã€‚

###è¡¥å……

å°½ç®¡å¯¹äºæ¨¡ç³ŠåŒ¹é…ï¼Œå•å€¼ç´¢å¼•ä¸èµ·ä½œç”¨ï¼Œä½†æ˜¯å¯¹äºå‰ç¼€åŒ¹é…æŸ¥è¯¢ï¼Œå•å€¼ç´¢å¼•èƒ½åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚

## ä»…å»ºç«‹æ–‡æœ¬ç´¢å¼•

### æŸ¥è¯¢åˆ†æå‘½ä»¤ç»“æœ

æŸ¥è¯¢å‘½ä»¤ï¼š`db.onlyDoc.find({$text: {$search: "spark"}}).sort({year: 1})`

æ˜¾ç¤ºæŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’å‘½ä»¤ï¼š`db.onlyDoc.explain("allPlansExecution").find({$text: {$search: "spark"}}).sort({year: 1})`

```json
[
  {
    "executionStats": {
      "executionSuccess": true,
      "nReturned": 1,
      "executionTimeMillis": 18,
      "totalKeysExamined": 1415,
      "totalDocsExamined": 1415,
      "executionStages": {
        "stage": "SORT",
        "nReturned": 1,
        "executionTimeMillisEstimate": 0,
        "works": 1419,
        "advanced": 1,
        "needTime": 1417,
        "needYield": 0,
        "saveState": 11,
        "restoreState": 11,
        "isEOF": 1,
        "sortPattern": {
          "year": 1
        },
        "memUsage": 597,
        "memLimit": 33554432,
        "limitAmount": 1,
        "inputStage": {
          "stage": "SORT_KEY_GENERATOR",
          "nReturned": 1415,
          "executionTimeMillisEstimate": 0,
          "works": 1417,
          "advanced": 1415,
          "needTime": 1,
          "needYield": 0,
          "saveState": 11,
          "restoreState": 11,
          "isEOF": 1,
          "inputStage": {
            "stage": "TEXT",
            "nReturned": 1415,
            "executionTimeMillisEstimate": 0,
            "works": 1416,
            "advanced": 1415,
            "needTime": 0,
            "needYield": 0,
            "saveState": 11,
            "restoreState": 11,
            "isEOF": 1,
            "indexPrefix": {
            },
            "indexName": "title_text",
            "parsedTextQuery": {
              "terms": ["spark"],
              "negatedTerms": [],
              "phrases": [],
              "negatedPhrases": []
            },
            "textIndexVersion": 3,
            "inputStage": {
              "stage": "TEXT_MATCH",
              "nReturned": 1415,
              "executionTimeMillisEstimate": 0,
              "works": 1416,
              "advanced": 1415,
              "needTime": 0,
              "needYield": 0,
              "saveState": 11,
              "restoreState": 11,
              "isEOF": 1,
              "docsRejected": 0,
              "inputStage": {
                "stage": "FETCH",
                "nReturned": 1415,
                "executionTimeMillisEstimate": 0,
                "works": 1416,
                "advanced": 1415,
                "needTime": 0,
                "needYield": 0,
                "saveState": 11,
                "restoreState": 11,
                "isEOF": 1,
                "docsExamined": 1415,
                "alreadyHasObj": 0,
                "inputStage": {
                  "stage": "OR",
                  "nReturned": 1415,
                  "executionTimeMillisEstimate": 0,
                  "works": 1416,
                  "advanced": 1415,
                  "needTime": 0,
                  "needYield": 0,
                  "saveState": 11,
                  "restoreState": 11,
                  "isEOF": 1,
                  "dupsTested": 1415,
                  "dupsDropped": 0,
                  "inputStage": {
                    "stage": "IXSCAN",
                    "nReturned": 1415,
                    "executionTimeMillisEstimate": 0,
                    "works": 1416,
                    "advanced": 1415,
                    "needTime": 0,
                    "needYield": 0,
                    "saveState": 11,
                    "restoreState": 11,
                    "isEOF": 1,
                    "keyPattern": {
                      "_fts": "text",
                      "_ftsx": 1
                    },
                    "indexName": "title_text",
                    "isMultiKey": true,
                    "isUnique": false,
                    "isSparse": false,
                    "isPartial": false,
                    "indexVersion": 2,
                    "direction": "backward",
                    "indexBounds": {
                    },
                    "keysExamined": 1415,
                    "seeks": 1,
                    "dupsTested": 1415,
                    "dupsDropped": 0
                  }
                }
              }
            }
          }
        }
      },
      "allPlansExecution": []
    },
    "ok": 1,
    "queryPlanner": {
      "plannerVersion": 1,
      "namespace": "SparkDBLPTest.onlyDoc",
      "indexFilterSet": false,
      "parsedQuery": {
        "$text": {
          "$search": "spark",
          "$language": "english",
          "$caseSensitive": false,
          "$diacriticSensitive": false
        }
      },
      "winningPlan": {
        "stage": "SORT",
        "sortPattern": {
          "year": 1
        },
        "limitAmount": 1,
        "inputStage": {
          "stage": "SORT_KEY_GENERATOR",
          "inputStage": {
            "stage": "TEXT",
            "indexPrefix": {
            },
            "indexName": "title_text",
            "parsedTextQuery": {
              "terms": ["spark"],
              "negatedTerms": [],
              "phrases": [],
              "negatedPhrases": []
            },
            "textIndexVersion": 3,
            "inputStage": {
              "stage": "TEXT_MATCH",
              "inputStage": {
                "stage": "FETCH",
                "inputStage": {
                  "stage": "OR",
                  "inputStage": {
                    "stage": "IXSCAN",
                    "keyPattern": {
                      "_fts": "text",
                      "_ftsx": 1
                    },
                    "indexName": "title_text",
                    "isMultiKey": true,
                    "isUnique": false,
                    "isSparse": false,
                    "isPartial": false,
                    "indexVersion": 2,
                    "direction": "backward",
                    "indexBounds": {
                    }
                  }
                }
              }
            }
          }
        }
      },
      "rejectedPlans": []
    },
    "serverInfo": {
      "host": "51c90cc27037",
      "port": 27017,
      "version": "4.2.6",
      "gitVersion": "20364840b8f1af16917e4c23c1b5f5efd8b352f8"
    }
  }
]
```

###åˆ†æ

> executionTimeMillis: 18
>
> totalKeysExamined: 1415
>
> totalDocsExamined: 1415
>
> totalReturn:1415
>
> totalTime:305ms

æ–‡æœ¬ç´¢å¼•ç¡®å®èµ·åˆ°äº†ä½œç”¨ï¼ŒexecutionTimeMillisç”±åŸæ¥çš„31866æ˜¾è‘—ä¸‹é™è‡³18ï¼ŒtotalTimeä»…ä»…ä¸º305msã€‚

```mermaid
graph LR;
  OR-->FETCH
  IXSCAN-->OR
  TEXT_MATCH-->TEXT
  FETCH-->TEXT_MATCH
  TEXT-->LIMIT
  LIMIT-->SORT_KEY_GENERATOR
  SORT_KEY_GENERATOR -->SORT
```

ä½†æ˜¯æŸ¥è¯¢è¿”å›çš„æ–‡æ¡£æ•°é‡å´å‡å°‘ä¸º1415ï¼Œä½¿ç”¨æ¨¡ç³ŠåŒ¹é…çš„å€¼åˆ™ä¸º1,575ã€‚åŸå› æ˜¯å› ä¸ºæ–‡æœ¬ç´¢å¼•æ˜¯æ ¹æ®å•è¯å»ºç«‹çš„ã€‚æ‰€ä»¥ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š

> A 64-bit 0.81-mW 700-MS/s SAR ADC With Sparkle-Code Correction, Resolution Enhancement, and Background Window Width Calibration.

æ–‡æœ¬ç´¢å¼•ä¸ä¼šå‘½ä¸­è¯¥å­—ç¬¦ä¸²ï¼Œå› ä¸ºSparkleä¸è¢«è®¤ä¸ºåŒ¹é…Sparkï¼Œä½†æ˜¯Sparkleä¼šè¢«è®¤ä¸ºåŒ¹é…/spark/iã€‚æ–‡æœ¬ç´¢å¼•ä¾æ®ç‰¹å®šçš„å…³é”®è¯è¿›è¡ŒåŒ¹é…ï¼Œå¹¶ä¸”æ–‡æœ¬ç´¢å¼•è¿”å›ç»“æœæ›´ç²¾ç¡®ã€‚è¿™æ ·çš„åŒ¹é…è§„åˆ™æ˜¯ç¼ºç‚¹è¿˜æ˜¯ä¼˜ç‚¹ï¼Œè§ä»è§æ™ºã€‚è‡³å°‘å¯¹äºè¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œæ–‡æœ¬ç´¢å¼•çš„æŸ¥è¯¢ç»“æœæ›´åŠ å‡†ç¡®ï¼Œä¹Ÿæ›´åŠ å¿«é€Ÿã€‚

### ç»“è®º

æ–‡æœ¬ç´¢å¼•æ›´æ˜¾è‘—çš„å‡å°‘äº†æŸ¥è¯¢è¿”å›çš„æ—¶é—´ï¼Œ**ä½†æ˜¯å¹¶ä¸æ˜¯æ‰§è¡ŒçœŸæ­£çš„æ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢**ã€‚

Tipï¼šæ–‡æœ¬ç´¢å¼•ä¸æ”¯æŒæ’åº

> Sort operations cannot obtain sort order from a `text` index, even from a [compound text index](https://docs.mongodb.com/manual/core/index-text/#text-index-compound); i.e. sort operations cannot use the ordering in the text index.
>
> [MongoDB Documentation](https://docs.mongodb.com/manual/core/index-text/#restrictions)

##å¯¹æ¯”titleå’Œyearä¸Šçš„å››ç§ç´¢å¼•æ–¹æ¡ˆ

### å€¼å¾—æ³¨æ„çš„ç°è±¡ä¸è§£é‡Š

1. åœ¨yearå»ºç«‹çš„å•å€¼ç´¢å¼•æ‹–å»¶äº†è¿”å›å…¨éƒ¨ç»“æœçš„é€Ÿåº¦

   æ ¹æ®â€æœªå»ºç«‹ä»»ä½•ç´¢å¼•â€œå’Œâ€yearå­—æ®µå»ºç«‹å•å€¼ç´¢å¼•â€œçš„totalTimeï¼Œå‘ç°åœ¨yearå»ºç«‹çš„å•å€¼ç´¢å¼•æ‹–å»¶äº†æŸ¥è¯¢é€Ÿåº¦ã€‚å› ä¸ºåœ¨æ‰§è¡Œè¿‡æ»¤å‰éœ€è¦ä½¿ç”¨yearå­—æ®µæ’åºï¼Œæ­¤æ—¶éœ€è¦æ‰«ææ‰€æœ‰çš„yearä¸Šçš„ç´¢å¼•ã€‚ä½†æ˜¯å¯¹äºfindFirsté€»è¾‘ï¼Œyearå­—æ®µå»ºç«‹çš„ç´¢å¼•ç¡®å®åŠ å¿«äº†æŸ¥è¯¢é€Ÿåº¦ã€‚

2. åœ¨titleå»ºç«‹çš„å•å€¼ç´¢å¼•å¯¹æŸ¥è¯¢é€Ÿåº¦çš„ä¼˜åŒ–æ•ˆæœæœ‰é™

   æ ¹æ®â€æœªå»ºç«‹ä»»ä½•ç´¢å¼•â€œå’Œâ€titleå­—æ®µå»ºç«‹å•å€¼ç´¢å¼•â€˜çš„totalTimeå‘ç°titleå»ºç«‹çš„å•å€¼ç´¢å¼•å¯¹æŸ¥è¯¢é€Ÿåº¦çš„ä¼˜åŒ–æ•ˆæœæœ‰é™ã€‚å¯¹äºfindFirsté€»è¾‘çš„ä¼˜åŒ–ä¹Ÿæ²¡æœ‰æœ¬è´¨ä¸Šçš„æå‡ã€‚

3. æ–‡æœ¬ç´¢å¼•åœ¨findFirstå’ŒfindAllé€»è¾‘çš„æƒ…å†µä¸‹æŸ¥è¯¢ç»“æœæ›´å‡†ç¡®æ›´å¿«é€Ÿ

   æ ¹æ®â€æœªå»ºç«‹ä»»ä½•ç´¢å¼•â€œå’Œâ€titleå­—æ®µå»ºç«‹å•å€¼ç´¢å¼•â€œå’Œâ€titleå­—æ®µå»ºç«‹æ–‡æœ¬ç´¢å¼•â€çš„totalTimeå¯çŸ¥æ–‡æœ¬ç´¢å¼•çš„ä¼˜åŒ–æ–¹æ³•æ•ˆæœæ‹”ç¾¤ã€‚

###å†³ç­–

ç›®å‰æ‰“ç®—ï¼Œé»˜è®¤ä½¿ç”¨æ–‡æœ¬ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ã€‚

```
db.onlyDoc.createIndex({title: "text"});
```

# å®éªŒè®°å½• 2020-07-20 é’ˆå¯¹refinelistçš„ç¼“å­˜ä¼˜åŒ–

éœ€æ±‚æè¿°ï¼šç½‘ç«™ç”¨æˆ·éœ€è¦æ ¹æ®ä¸åŒçš„è¿‡æ»¤æ¡ä»¶ç­›é€‰æ–‡ç« 

é—®é¢˜æè¿°ï¼š

<img src="/Users/gaoxin/Library/Application Support/typora-user-images/æˆªå±2020-08-04 ä¸‹åˆ10.54.51.png" alt="æˆªå±2020-08-04 ä¸‹åˆ10.54.51" style="zoom:50%;" />

ç”¨æˆ·éœ€è¦æ ¹æ®refinelistçš„å†…å®¹ç­›é€‰æ–‡ç« ï¼Œè€Œrefinelistçš„å†…å®¹éœ€è¦æ ¹æ®ç­›é€‰çš„ç»“æœåŠ¨æ€æ›´æ–°ã€‚ç”Ÿæˆrefinelistçš„æ–¹å¼éœ€è¦é¢‘ç¹è¯»å–æ•°æ®åº“å¹¶è¿›è¡Œèšåˆæ“ä½œï¼Œè¿™ä¼šå¯¹æ•°æ®åº“é€ æˆå¾ˆå¤§å‹åŠ›ã€‚

è§£å†³æ–¹æ¡ˆï¼šåœ¨æœåŠ¡å™¨å»ºç«‹ç¼“å­˜ï¼Œå°†èšåˆæ“ä½œä¸Šæ¨åˆ°æœåŠ¡å™¨å±‚é¢å®Œæˆã€‚

å®ç°æ–¹å¼ï¼šä½¿ç”¨spring-cacheå®ç°ç¼“å­˜ï¼Œä½¿ç”¨Java stream APIå®ç°èšåˆæ“ä½œ



## å®ç°ç¼“å­˜çš„é…ç½®

findAllByTitleMatchesTextReturnListæ–¹æ³•çš„è¿”å›å€¼ä¼šè¢«ç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡è°ƒç”¨åˆæ ¼æ–¹æ³•å°±ä»ç¼“å­˜ç›´æ¥æ‹¿ã€‚ä¸ºäº†æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œåªå°†titleä½œä¸ºç¼“å­˜çš„keyã€‚

```java
/**
 * å…³é”®çš„æ ¹æ®å…³é”®å­—è·å–åŒ¹é…ç»“æœ
 *
 * @param title åŒ¹é…çš„titleå…³é”®å­—
 * @return åŒ¹é…æˆåŠŸçš„OnlyDocåˆ—è¡¨
 * @apiNote è¯¥æœåŠ¡ä¼šå¯¹æ•°æ®è¿›è¡Œç¼“å­˜
 */
@Cacheable(value = "findAllByTitleMatchesTextReturnStream", key = "#title")
public List<OnlyDoc> findAllByTitleMatchesTextReturnList(String title) {
    return dao.findAllByTextReturnListJPA(title);
}
```

## è¿‡æ»¤å’Œèšåˆçš„å®ç°

æœåŠ¡å™¨æœ‰4ä¸ªè¿”å›refinelistçš„æ¥å£ï¼Œè¿˜æœ‰ä¸€ä¸ªè¿”å›æ ¹æ®titleè¿›è¡ŒæŸ¥è¯¢çš„ç»“æœã€‚æˆ‘ä»¬è®¾è®¡è®©å‰ç«¯è¦ç­‰åˆ°æ ¹æ®titleè¿›è¡ŒæŸ¥è¯¢çš„ç»“æœè¿”å›åæ‰è¯·æ±‚refinelistã€‚å› ä¸ºå‰ç«¯å¾—åˆ°æ ¹æ®titleè¿›è¡ŒæŸ¥è¯¢çš„ç»“æœåï¼ŒæœåŠ¡ç«¯ä¹Ÿå¯¹è¿™ä¸ªç»“æœåšäº†ç¼“å­˜ã€‚è¿™æ ·è¿”å›refinelistçš„æ¥å£ä½¿ç”¨findAllByTitleMatchesTextReturnListæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªç¼“å­˜ä¸€å®šä¼šè¢«å‘½ä¸­ã€‚

æ‰€æœ‰è¿”å›refinelistçš„æ–¹æ³•éƒ½é¦–å…ˆä»findAllByTitleMatchesTextReturnListæ–¹æ³•é‡Œè·å–æ ¹æ®titleè¿›è¡ŒæŸ¥è¯¢çš„ç»“æœï¼Œç„¶åé€šè¿‡`Colection.Stream`è½¬åŒ–ä¸ºæµï¼ˆå®é™…ä½¿ç”¨çš„æ˜¯parallelStreamï¼Œè¿™æ˜¯Streamçš„å¹¶è¡Œä¼˜åŒ–ç‰ˆæœ¬APIï¼‰ã€‚ç„¶åé€šè¿‡Streamçš„APIæ¯”å¦‚`filter`ã€`map`ã€`collect`å®Œæˆè¿‡æ»¤å’Œèšåˆï¼Œå¹¶è¿”å›ç»™å‰ç«¯ã€‚

###è¿‡æ»¤æ“ä½œ

```java
/**
 * æ ¹æ®yearå­—æ®µä½¿ç”¨æµè¿‡æ»¤
 *
 * @param stream    è¾“å…¥æµ
 * @param yearArray æ¡ä»¶é›†åˆ
 * @return ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æµ
 */
public Stream<OnlyDoc> filterByYear(Stream<OnlyDoc> stream, String[] yearArray) {
    return stream.filter(onlyDoc -> {
        Long docYear = onlyDoc.getYearOption().orElse(0L);
        for (String it : yearArray) if (docYear.equals(Long.valueOf(it))) return true;
        return false;
    });
}

/**
 * æ ¹æ®venueå­—æ®µä½¿ç”¨æµè¿‡æ»¤
 *
 * @param stream     è¾“å…¥æµ
 * @param venueArray æ¡ä»¶é›†åˆ
 * @return ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æµ
 */
public Stream<OnlyDoc> filterByVenue(Stream<OnlyDoc> stream, String[] venueArray) {
    return stream.filter(onlyDoc -> {
        String docPrefix2 = onlyDoc.getPrefix2Option().orElse("");
        for (String it : venueArray) if (docPrefix2.equals(it)) return true;
        return false;
    });
}

/**
 * æ ¹æ®typeå­—æ®µä½¿ç”¨æµè¿‡æ»¤
 *
 * @param stream    è¾“å…¥æµ
 * @param typeArray æ¡ä»¶é›†åˆ
 * @return ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æµ
 */
public Stream<OnlyDoc> filterByType(Stream<OnlyDoc> stream, String[] typeArray) {
    return stream.filter(onlyDoc -> {
        String docPrefix2 = onlyDoc.getTypeOption().orElse("");
        for (String it : typeArray) if (docPrefix2.equals(it)) return true;
        return false;
    });
}

/**
 * æ ¹æ®authroå­—æ®µä½¿ç”¨æµè¿‡æ»¤
 *
 * @param stream      è¾“å…¥æµ
 * @param authorArray æ¡ä»¶é›†åˆ
 * @return ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æµ
 */
public Stream<OnlyDoc> filterByAuthor(Stream<OnlyDoc> stream, String[] authorArray) {
    return stream.filter(onlyDoc -> {
        List<String> list = onlyDoc.getAuthorOption()
                .orElse(new ArrayList<>())
                .stream()
                .map(Author::get_VALUE)
                .collect(Collectors.toList());
        for (String s : authorArray) if (list.contains(s)) return true;
        return false;
    });
}
```

### æ ¹æ®è¿‡æ»¤æ¡ä»¶å¦‚ä½•åšå¤„ç†

```java
    @GetMapping(value = "/findAllByTitleMatchesTextYearRefineList")
    public List<AggClass> findAllByTitleMatchesTextYearRefineList(
            @RequestParam String title,
            @RequestParam(required = false) String author,
            @RequestParam(required = false) String year,
            @RequestParam(required = false) String venue,
            @RequestParam(required = false) String type
    ) {
        //åˆå§‹åŒ–èšåˆç»“æœlist
        List<AggClass> aggClassList = new LinkedList<>();
        //å¯¹serviceçš„ç»“æœæµåŒ–
        Stream<OnlyDoc> parallelStream = service.findAllByTitleMatchesTextReturnList(title).parallelStream();

        //å¤„ç†æ ¹æ®authorçš„è¿‡æ»¤
        String[] authorArray;
        if (author == null) authorArray = null;
        else authorArray = author.split(",");
        if (authorArray != null) {
            parallelStream = service.filterByAuthor(parallelStream, authorArray);
        }

        //å¤„ç†æ ¹æ®yearçš„è¿‡æ»¤
        String[] yearArray;
        if (year == null) yearArray = null;
        else yearArray = year.split(",");
        if (yearArray != null) {
            parallelStream = service.filterByYear(parallelStream, yearArray);
        }

        //å¤„ç†æ ¹æ®prefix2çš„è¿‡æ»¤
        String[] venueArray;
        if (venue == null) venueArray = null;
        else venueArray = venue.split(",");
        if (venueArray != null) {
            parallelStream = service.filterByVenue(parallelStream, venueArray);
        }

        //å¤„ç†æ ¹æ®typeçš„è¿‡æ»¤
        String[] typeArray;
        if (type == null) typeArray = null;
        else typeArray = type.split(",");
        if (typeArray != null) {
            parallelStream = service.filterByType(parallelStream, typeArray);
        }

        //èšåˆå¤„ç†
        parallelStream
                .collect(Collectors.groupingByConcurrent(OnlyDoc::getYear, Collectors.counting()))
                .forEach((key, value) -> aggClassList.add(new AggClass(String.valueOf(key), value)));
//        System.out.println(aggClassList.size());
        aggClassList.sort((o1, o2) -> Math.toIntExact(o2.getCount() - o1.getCount()));
//        aggClassList.forEach(System.out::println);
        return aggClassList;
    }
```

